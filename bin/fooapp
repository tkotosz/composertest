#!/bin/env php
<?php

require __DIR__ . '/../vendor/autoload.php';

use Tkotosz\FooApp\Composer\Composer;
use Tkotosz\FooApp\Composer\ComposerConfig;

$config = [
    'app_dir' => '.fooapp',
    'root_requirements' => [
        'tkotosz/fooapp-extension-api' => '*'
    ],
    'repositories' => [
        ['type' => 'path', 'url' => 'core-extensions/*'],
        ['type' => 'path', 'url' => 'fooapp-extension-api/'],
    ]
];

$composerConfig = new ComposerConfig(
    $config['app_dir'],
    $config['root_requirements'],
    $config['repositories']
);

$appAutoload = getcwd() . '/' . $composerConfig->appDir() . '/autoload.php';

if (!file_exists($appAutoload)) {
    $composer = new Composer($composerConfig);

    $result = $composer->init();

    if ($result->isError()) {
        echo $result->output();
        exit(255);
    }
}

require $appAutoload;

$extensions = require getcwd() . '/' . $composerConfig->appDir() . '/extensions.php';
$application = new \Tkotosz\FooApp\Application($extensions);
$application->run($composerConfig);
