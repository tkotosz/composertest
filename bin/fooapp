#!/bin/env php
<?php

require __DIR__ . '/../vendor/autoload.php';

use Tkotosz\FooAppCli\Composer\Composer;
use Tkotosz\FooAppCli\Composer\ComposerConfig;
use Tkotosz\FooAppCli\Console\Command\ExtensionInstallCommand;

$config = require __DIR__ . '/../src/config/config.php';
$composerConfig = new ComposerConfig(
    $config['app_dir'],
    $config['root_requirements'],
    $config['repositories']
);

$appAutoload = getcwd() . '/' . $composerConfig->appDir() . '/autoload.php';

if (!file_exists($appAutoload)) {
    $composer = new Composer($composerConfig);

    $result = $composer->init();

    if ($result->isError()) {
        echo $result->output();
        exit(255);
    }
}

require $appAutoload;

$baseCli = new \Symfony\Component\Console\Application('dd', '1.0.0');
$baseCli->add(new ExtensionInstallCommand($composerConfig));

$extensions = require getcwd() . '/' . $composerConfig->appDir() . '/extensions.php';
$callBack = function () use ($baseCli) {
    $baseCli->run();
};

$mainApp = $config['main_application'];
if (!class_exists($mainApp)) {
    echo "Could not autoload the main application ($mainApp)";
    exit(255);
}

$application = new $mainApp($extensions, $callBack);

$application->run();
