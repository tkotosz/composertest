#!/bin/env php
<?php

require __DIR__ . '/../vendor/autoload.php';

if (file_exists(__DIR__ . '/../vendor-custom/autoload.php')) {
    require __DIR__ . '/../vendor-custom/autoload.php';
}

$plugins = array_map(function ($className) {
    return new $className;
}, require __DIR__ . '/../plugins.php');

use Composer\Factory;
use Composer\Installer;
use Composer\IO\ConsoleIO;
use Symfony\Component\Console\Helper\HelperSet;
use Symfony\Component\Console\Helper\QuestionHelper;
use Symfony\Component\Console\Input\ArgvInput;
use Symfony\Component\Console\Output\ConsoleOutput;

try {
    if ($_SERVER['argv'][1] ?? '' === 'install') {

        $composerIo = new ConsoleIO(
            new ArgvInput(),
            new ConsoleOutput(),
            new HelperSet(['question' => new QuestionHelper()])
        );

        $customComposer = Factory::create(
            $composerIo,
            'custom-composer.json',
            true
        );

        $installer = Installer::create(
            $composerIo,
            $customComposer
        );

        $installer
            ->setUpdate(true)
            ->setWriteLock(false)
            ->setDevMode(false)
            ->setPreferStable(true)
            ->run();
    } else {
        foreach ($plugins as $plugin) {
            $plugin->load();
        }
    }

} catch (\Exception $e) {
    echo $e->getMessage() . PHP_EOL;
}
